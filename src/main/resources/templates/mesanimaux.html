<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Adoption</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="css/adoption_afficher_animal.css">
    <style>
        /* Styles personnalis√©s pour la modal */
        .modal-adoption .modal-body {
            padding: 70px;
        }

        /* Ajustements sp√©cifiques aux √©l√©ments du formulaire */
        .modal-adoption form {
            margin-bottom: 20px;
        }

        .modal-adoption label {
            font-weight: bold;
        }

        /* Ajoutez d'autres styles personnalis√©s au besoin */
    </style>
</head>

<body>
    <!-- Modal d'adoption -->
    <div class="modal" id="adoptionModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Formulaire d'adoption</h4><br>
                    <button type="button" class="close" data-dismiss="modal"
                        onclick="closeAdoptionPopup">&times;</button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">

                    <!-- Formulaire d'adoption avec les champs de date et de checkbox -->
                    <form id="adoptionForm">
                        <!-- Ajout du champ pour l'ID de l'animal -->
                        <input type="hidden" id="animalId" name="animalId" value="">

                        <div class="form-group">
                            <label for="startDate">Date de d√©but d'adoption</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>

                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="finalAdoption"
                                onchange="toggleEndDate()">
                            <label class="form-check-label" for="finalAdoption">Adoption temporaire</label>
                        </div>

                        <div class="form-group">
                            <label for="endDate">Date de fin d'adoption</label>
                            <input type="date" class="form-control" id="endDate" disabled>
                        </div>
                    </form>

                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal"
                        onclick="closeAdoptionPopup">Fermer</button>
                    <button type="button" class="btn btn-primary" onclick="submitForm()">Enregistrer</button>
                </div>

            </div>
        </div>
    </div>

    <div class="wrapper">
        <div class="container">
            <div class="title">
                <h1>Mes animaux</h1>
            </div>

            <div class="animal">
                <!-- Ajouter un champ cach√© pour l'ID de la personne -->

                <div class="animal-container">
                    <!-- Liste des animaux ici -->
                </div>
                <div id="error-message"></div>
            </div>
        </div>
    </div>

    <!-- Inclusion de jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT"
        crossorigin="anonymous"></script>

    <!-- Inclusion de Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <script>

        function handleDonationClick ( animalId )
        {
            // D√©finir l'ID de l'animal dans le champ d'input cach√©
            document.getElementById( 'animalId' ).value = animalId;
        }




        function submitForm ()
        {
            var animalId = document.getElementById( 'animalId' ).value;
            var startDate = document.getElementById( "startDate" ).value;
            var isFinalAdoption = document.getElementById( "finalAdoption" ).checked;
            var endDate = isFinalAdoption ? document.getElementById( "endDate" ).value : "0000-01-01";

            if ( isFinalAdoption && new Date( endDate ) <= new Date( startDate ) ) {
                alert( "La date de fin doit √™tre ult√©rieure √† la date de d√©but." );
                return;
            }

            var adoptionData = {
                startDate: startDate,
                endDate: endDate,
                isFinalAdoption: isFinalAdoption,
                idAnimal: animalId
            };

            $.ajax( {
                url: "/animal/addadoption",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify( adoptionData ),
                success: function ( data )
                {
                    if ( data && data.message ) {
                        alert( "Enregistrement r√©ussi : " + data.message );
                    } else {
                        alert( "La r√©ponse ne contient pas de message." );
                    }
                },
                error: function ( xhr, status, error )
                {
                    alert( "Erreur lors de l'enregistrement : " + error );
                }
            } );
        }


        function toggleEndDate ()
        {
            var endDateInput = document.getElementById( "endDate" );
            var finalAdoptionCheckbox = document.getElementById( "finalAdoption" );

            endDateInput.disabled = !finalAdoptionCheckbox.checked;
        }
    </script>












    <script>




        function fetchData ( userId )
        {
            var personId; // D√©clarer la variable √† l'ext√©rieur de la fonction AJAX

            $.ajax( {
                url: "/person/profile",
                type: "GET",
                success: function ( data )
                {
                    // Mettre √† jour la valeur de l'ID dans le champ cach√©
                    $( "#idPerson" ).val( data.id );

                    // Affecter la valeur √† la variable personId
                    personId = data.id;
                    console.log( personId );

                    // Maintenant, vous pouvez utiliser personId pour construire l'URL
                    let url = "/animal/person/" + personId;

                    fetch( url )
                        .then( ( response ) => response.json() )
                        .then( ( data ) =>
                        {
                            if ( data.length > 0 ) {
                                console.log( data );
                                displayAnimals( data );
                                document.getElementById( "error-message" ).textContent = "";
                            } else {
                                document.getElementById( "error-message" ).innerHTML = "<p class='message-error'>Aucun r√©sultat. Vous n'avez aucun animal</p>";
                            }
                        } )
                        .catch( ( error ) =>
                        {
                            console.error( "Error fetching data:", error );
                        } );
                },
                error: function ( xhr, status, error )
                {
                    // G√©rer les erreurs
                }
            } );
        }


        function fetchAnimalDetails ( animalURI )
        {


            console.log( animalURI )

            return fetch( animalURI )
                .then( ( response ) => response.json() )
                .catch( ( error ) =>
                {
                    console.error( `Error fetching animal details for this URI ${ animalURI }:`, error );

                } );
        }

        async function displayAnimals ( animals )
        {
            if ( animals.length > 0 ) {
                let animalList = ``;



                for ( let i = 0; i < animals.length; i++ ) {

                    const animalRef = animals[ i ];
                    console.log( animalRef );

                    // Fetch details for each animal
                    const animalDetails = await fetchAnimalDetails( animalRef );

                    if ( animalDetails ) {
                        animalList += `
                    <div class="animal-item">
                        <div class="animal-img">
                            <img src="/images/animals/${animalDetails.imageUrl}" alt="animal image">
                            <div>
                                <button type="button" class="add-btn" onclick="window.location.href = 'candidature?id=${ animalDetails.id }'">Candidatures &#x1F600;</button>
                                <button type="button" class="add-btn" onclick="window.location.href = 'suivi?id=${ animalDetails.id }'">Vaccinations üíâ</button>
                                 
                                <button type="button" class="add-btn" data-toggle="modal" data-target="#adoptionModal" onclick="handleDonationClick(${ animalDetails.id })">Donner üôè</button>



                            </div>
                        </div>
                        <div class="animal-content">
                            <a href="#" class="animal-title">üî• ${ animalDetails.name } </a>
                            <p class="race"><span>‚ÑπÔ∏è ${ animalDetails.race }</span></p>
                            <div>
                                <span class="gender">${ animalDetails.gender === 1 ? '‚ôÇ M√¢le' : '‚ôÄ Femelle' }</span>
                            </div>
                        </div>
                    </div>
                `;
                    }
                }


                const animalListDiv = document.querySelector( ".animal-container" );
                animalListDiv.innerHTML = animalList;
            }
        }

        //envoy√© l'i a la page donn√© et a la page

        // Cette fonction sera appel√©e lorsque la page se chargera
        window.onload = function ()
        {
            // Vous pouvez ajuster l'ID de l'utilisateur ici (par exemple, 1)
            fetchData();
        };

    </script>

</body>

</html>